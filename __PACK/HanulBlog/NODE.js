HanulBlog.ArticleModel=OBJECT({preset:function(){"use strict";return HanulBlog.MODEL},params:function(){"use strict";var t={category:{notEmpty:!0,size:{max:255}},title:!0,content:{notEmpty:!0}};return{name:"Article",methodConfig:{create:{valid:VALID(t),role:"ADMIN"},update:{valid:VALID(t),role:"ADMIN"},remove:{role:"ADMIN"}}}}}),HanulBlog.CategoryModel=OBJECT({preset:function(){"use strict";return HanulBlog.MODEL},params:function(){"use strict";var t={id:{notEmpty:!0,size:{max:255}},articleCount:{notEmpty:!0,integer:!0}};return{name:"Category",isNotUsingObjectId:!0,initData:{articleCount:1},methodConfig:{create:{valid:VALID(t),role:"ADMIN"},update:{valid:VALID(t),role:"ADMIN"},remove:{role:"ADMIN"}}}}}),HanulBlog.CommentModel=OBJECT({preset:function(){"use strict";return HanulBlog.MODEL},params:function(){"use strict";var t={articleId:{notEmpty:!0,id:!0},name:{notEmpty:!0,size:{max:20}},password:{notEmpty:!0,size:{min:4,max:20}},content:{notEmpty:!0,size:{max:1e3}}};return{name:"Comment",methodConfig:{create:{valid:VALID(t)},update:!1,remove:!1}}}});OVERRIDE(HanulBlog.ArticleModel,function(o){"use strict";HanulBlog.ArticleModel=OBJECT({preset:function(){return o},init:function(o,n,t){o.on("create",{before:function(o,n){return GET({host:"tagengine.hanul.co",uri:"__TAG_INPUT",paramStr:"tag="+encodeURIComponent(o.category)},function(t){o.category=t,HanulBlog.CategoryModel.update({id:t,$inc:{articleCount:1}},{notExists:function(){HanulBlog.CategoryModel.create({id:t},n)},success:n})}),!1}}),o.on("update",{before:function(o,t){return n.get(o.id,function(n){n.category===o.category?t():GET({host:"tagengine.hanul.co",uri:"__TAG_INPUT",paramStr:"tag="+encodeURIComponent(o.category)},function(e){o.category=e,n.category===o.category?t():NEXT([function(o){HanulBlog.CategoryModel.update({id:e,$inc:{articleCount:1}},{notExists:function(){HanulBlog.CategoryModel.create({id:e},o)},success:o})},function(){return function(){HanulBlog.CategoryModel.update({id:n.category,$inc:{articleCount:-1}},function(o){0===o.articleCount?HanulBlog.CategoryModel.remove(o.id,t):t()})}}])})}),!1}}),o.on("remove",{after:function(o){HanulBlog.CategoryModel.update({id:o.category,$inc:{articleCount:-1}},function(o){0===o.articleCount&&HanulBlog.CategoryModel.remove(o.id)})}}),HanulBlog.ROOM(n.getName(),function(o,t){t("changeCategory",function(o,t){var e,a;void 0!==o&&(e=o.originCategory,a=o.newCategory,n.find({filter:{category:e},isFindAll:!0},function(o){var e;NEXT(o,[function(o,t){n.update({id:o.id,category:a},function(o){e=o,t()})},function(){return function(){t(void 0===e?a:e.category)}}])}))})})}})}),OVERRIDE(HanulBlog.CommentModel,function(o){"use strict";HanulBlog.CommentModel=OBJECT({preset:function(){return o},init:function(o,n,t){o.on("create",{before:function(o){void 0!==o.articleId&&void 0!==o.password&&(o.password=SHA1({key:o.articleId,password:o.password}))}}),HanulBlog.ROOM(n.getName(),function(o,t){t("remove",function(o,t){var e,a;void 0!==o&&void 0!==o.password&&null!==o.password&&(e=o.id,a=o.password,n.get(e,function(o){o.password===SHA1({key:o.articleId,password:a})&&n.remove(e),t(o.password===SHA1({key:o.articleId,password:a}))}))})})}})}),HanulBlog.AuthRoom=OBJECT({init:function(){"use strict";HanulBlog.ROOM("authRoom",function(o,n,t){n("auth",function(n,t){n===NODE_CONFIG.HanulBlog.password&&(o.roles=["ADMIN"]),t(n===NODE_CONFIG.HanulBlog.password)})})}});